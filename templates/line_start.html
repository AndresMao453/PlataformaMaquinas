{% extends "base.html" %}
{% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/line_start.css') }}">

<div class="top-header">
  <div class="card" style="padding:18px 22px;">
    <div class="title-blue" style="font-size:48px; margin:0;">
      {{ line_title }}
    </div>
    <p class="subtitle" style="margin-top:6px;">{{ line_desc }}</p>

    {# =========================================================
       APLICACI√ìN / UNI√ìN (stage upload): subcat + dropdown + auto-submit
       - ‚úÖ Uni√≥n habilitada
       - ‚úÖ M√°quina 1 y M√°quina 2 habilitadas (el JS decide/valida)
       - ‚úÖ sin "Pr√≥ximamente"
       ========================================================= #}
    {% if line_key == "aplicacion" and stage == "upload" %}
      <div class="subcat-wrap">
        <p class="subtitle" style="margin-top:14px;">Selecciona la categor√≠a:</p>

        <div class="subcat-grid">
          <!-- ‚úÖ HABILITADO -->
          <div class="subcat-card app" onclick="selectSubcat('aplicacion', this)">
            <div class="subcat-name">Aplicaci√≥n</div>
            <p class="subcat-desc">Crimpado / aplicaci√≥n de terminales.</p>
          </div>

          <!-- ‚úÖ HABILITADO -->
          <div class="subcat-card union" id="subcatUnionCard" onclick="selectSubcat('union', this)">
            <div class="subcat-name">Uni√≥n</div>
            <p class="subcat-desc">Operaci√≥n de uni√≥n / ensamble.</p>
          </div>
        </div>

        <p class="subtitle" style="margin-top:10px;">
          Categor√≠a seleccionada: <b id="subcatLabel">‚Äî</b>
        </p>

        <!-- ‚úÖ BLOQUE M√ÅQUINA (tu JS lo muestra/oculta) -->
        <div id="appMachineWrap" class="app-machine-center" style="display:none; margin-top:12px;">

          <h2 class="machine-title machine-title-center">
            <span class="typer-box">
              <span class="typer-ghost">Selecciona la m√°quina:</span>
              <span id="selectMachineTitle" class="typer-live" data-text="Selecciona la m√°quina:">
                Selecciona la m√°quina:
              </span>
            </span>
          </h2>

          <div class="select-box" style="max-width:420px;">
            <select id="appMachineSelect" onchange="onAppMachineChange(this)">
              <option value="">Selecciona...</option>
              <option value="1">M√°quina 1</option>
              <option value="2">M√°quina 2</option>
            </select>
          </div>

          {# Fuente opcional (si la quieres mostrar, solo descomenta) #}
          {#
          <p class="subtitle" style="margin-top:10px; opacity:.85;">
            Fuente: Google Sheets
            <a class="underline" target="_blank" href="https://docs.google.com/spreadsheets/d/XXXX/edit">
              Abrir
            </a>
          </p>
          #}

        </div>

        <!-- ‚úÖ FORM OCULTO: se env√≠a autom√°tico cuando subcat + m√°quina est√©n listos -->
        <form id="appAutoContinueForm" method="post" style="display:none;">
          <input type="hidden" name="machine" id="machineInput" value="">
          <input type="hidden" name="subcat" id="subcatInput" value="">
          <input type="hidden" name="machine_id" id="machineIdInput" value="">
          <input type="hidden" name="source" value="gsheet">
          <!-- sin duplicar name="machine_id" -->
          <input type="hidden" id="machineIdInput2" value="{{ machine_id or '' }}">
        </form>

        <div style="margin-top:14px;">
          <a class="btn secondary" href="{{ url_for('home') }}">Volver</a>
        </div>
      </div>
    {% endif %}

    {# =========================================================
       CORTE (stage upload): selector HP/THB como antes
       ========================================================= #}
    {% if line_key != "aplicacion" and stage == "upload" %}
      <p class="subtitle" style="margin-top:14px;">Primero selecciona la m√°quina:</p>

      <div class="machine-grid">
        <div class="machine-card hp" onclick="selectMachine('HP', this)">
          <div class="machine-name">HP</div>
          <p class="machine-desc">M√°quina de corte tipo HPC / l√≠nea HP.</p>
        </div>

        <div class="machine-card thb" onclick="selectMachine('THB', this)">
          <div class="machine-name">THB</div>
          <p class="machine-desc">M√°quina de corte THB HBQ / l√≠nea THB.</p>
        </div>
      </div>
    {% endif %}
  </div>
</div>



{% if not (line_key == "aplicacion" and stage == "upload") %}
<div style="width:min(1800px,98vw); margin:0 auto;">
  <div class="card fade-in" style="padding:18px 22px;">

    {# =========================================================
       stage upload:
       - APLICACI√ìN: NO mostrar "Cargar base de datos"
       - CORTE: mantener uploadBlock/hintBlock
       ========================================================= #}
    {% if stage == "upload" %}

      {% if line_key != "aplicacion" %}
        <div id="uploadBlock" style="display:none;">
          <div style="display:flex; justify-content:space-between; gap:14px; flex-wrap:wrap; align-items:center;">
            <div style="text-align:left;">
              <h2 style="margin:0;">Cargar base de datos</h2>
              <p class="subtitle" style="margin-top:6px;">
                M√°quina seleccionada: <b id="machineLabel"></b>
              </p>
            </div>

            <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">

              <!-- ‚úÖ Google Sheets (solo HP) -->
              <div id="gsheetHpWrap" style="display:none;">
                <form method="post" style="display:flex; gap:10px; align-items:center;">
                  <input type="hidden" name="machine" id="machineInputGs" value="">
                  <input type="hidden" name="source" value="gsheet">
                  <button class="btn" type="submit">Usar Google Sheets</button>
                </form>
              </div>

              <!-- ‚úÖ Excel local (como estaba) -->
              <form method="post"
                    enctype="multipart/form-data"
                    style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">

                <input type="hidden" name="machine" id="machineInput" value="">

                <input type="file" name="file" accept=".xlsx,.xls" required>
                <button class="btn" type="submit">Subir Excel</button>

                <a class="btn secondary" href="{{ url_for('home') }}">Volver</a>
              </form>

            </div>

          </div>
        </div>

        <div id="hintBlock" style="text-align:left;">
          <h2 style="margin:0;">Antes de continuar‚Ä¶</h2>
          <p class="subtitle" style="margin-top:6px;">
            Selecciona <b>HP</b> o <b>THB</b> para habilitar la carga del Excel.
          </p>
          <div style="margin-top:14px;">
            <a class="btn secondary" href="{{ url_for('home') }}">Volver</a>
          </div>
        </div>
      {% endif %}

    {% endif %}

    {% if stage == "select_sheet" %}
      <p class="subtitle" style="margin:0;">
        M√°quina: <b>{{ machine }}</b>
      </p>

      <h3 style="margin:6px 0 0 0;">¬øC√≥mo deseas analizar el tiempo?</h3>

      <form method="post" action="{{ url_for('run_analysis') }}" id="runForm">
        <input type="hidden" name="filename" value="{{ filename }}">
        <input type="hidden" name="analysis_key" value="{{ line_key }}">
        <input type="hidden" name="machine" value="{{ machine }}">
        <input type="hidden" name="period" id="periodInput" value="day">
        <input type="hidden" name="subcat" id="subcatInput2" value="{{ subcat or '' }}">

        <div class="time-grid">
          <div class="period-card selected" onclick="selectPeriod('day', this)">
            <div class="period-title">üìÖ Por D√≠a</div>
            <p class="period-desc">Agrupa por fecha.</p>
          </div>

          <div class="period-card" onclick="selectPeriod('week', this)">
            <div class="period-title">üóìÔ∏è Por Semana</div>
            <p class="period-desc">Agrupa semanalmente.</p>
          </div>

          <div class="period-card" onclick="selectPeriod('month', this)">
            <div class="period-title">üìÜ Por Mes</div>
            <p class="period-desc">Agrupa por mes.</p>
          </div>

          <div class="select-box">
            <label><b id="periodLabel">D√≠as disponibles</b></label>
            <select name="period_value" id="periodValueSelect" required onchange="onPeriodValueChange()">
              <option value="">Cargando...</option>
            </select>
          </div>

          <div class="action-box">
            <a class="btn secondary" href="{{ url_for('home') }}">Cambiar l√≠nea</a>
          </div>
        </div>

        <div id="thbFilters" style="display:none;">
          <div class="thb-filters">
            <div class="select-box">
              <label><b>Operaria</b></label>
              <select name="operator" id="operatorSelect" required>
                <option value="">Selecciona...</option>
              </select>
            </div>

            <div class="select-box">
              <label><b>Hora inicio</b></label>
              <input type="time" name="time_start" id="timeStart" required>
            </div>

            <div class="select-box">
              <label><b>Hora fin</b></label>
              <input type="time" name="time_end" id="timeEnd" required>
            </div>

            <div class="action-box">
              <button class="btn" type="submit" id="btnAnalyze" disabled>Ver KPIs</button>
            </div>
          </div>
        </div>

        <div id="inlineResults" class="card" style="margin-top:14px; display:none;">
          <div id="inlineHeader" class="subtitle" style="margin:0 0 6px 0;"></div>
          <div id="inlineTitle" class="inline-title" style="display:none;"></div>

          <div id="inlineKpis" class="kpi-grid"></div>

          <div id="hpTimesLine" class="subtitle"
               style="display:none; margin:8px 0 0 0; font-weight:900;">
          </div>

          <div id="inlineParetoTitle" class="inline-title" style="display:none; margin-top:18px;">
            An√°lisis de Pareto de Causas de Parada
          </div>

          <div id="paretoChartWrap" class="card" style="margin-top:12px; padding:14px; display:none;">
            <canvas id="paretoChart" height="120"></canvas>
          </div>

          <div id="paretoLegendWrap" class="card" style="margin-top:12px; padding:14px; display:none;">
            <h3 style="margin:0 0 10px 0;">Tabla Pareto (Paradas)</h3>
            <table class="pareto-table">
              <thead>
                <tr>
                  <th style="width:120px;">C√≥digo</th>
                  <th>Descripci√≥n</th>
                  <th style="width:120px; text-align:right;">Duraci√≥n</th>
                  <th style="width:90px; text-align:right;">% Acum.</th>
                </tr>
              </thead>
              <tbody id="paretoLegendBody"></tbody>
            </table>
            <div class="pareto-muted">Duraci√≥n mostrada en <b>HH:MM</b>. % acumulado sobre el total.</div>
          </div>

          <div id="terminalUsageTitle" class="inline-title" style="display:none; margin-top:18px;">
            Terminales m√°s usadas (Manual vs Carrete)
          </div>

          <div id="terminalUsageWrap" class="card" style="margin-top:12px; padding:14px; display:none;">
            <div id="terminalUsageGrid" class="tu-grid"></div>
          </div>

          <div id="prodHourTitleRow" class="ph-title-row" style="display:none; margin-top:18px;">
            <div id="prodHourTitle" class="inline-title" style="margin:0;">Productividad por hora</div>

            <div id="prodHourLegend" class="ph-legend">
              <span class="ph-legend-item"><span class="ph-dot len-short"></span> Peque√±o</span>
              <span class="ph-legend-item"><span class="ph-dot len-mid"></span> Mediano</span>
              <span class="ph-legend-item"><span class="ph-dot len-long"></span> Largo</span>
            </div>

          </div>



          <div id="prodHourWrap" class="card" style="margin-top:12px; padding:14px; display:none;">
            <div id="prodHourGrid" class="prod-hour-grid"></div>
          </div>


          <!-- =========================
               Modal THB: Tarjetas por hora
          ========================= -->
          <div id="thbTarjetasModal" class="thb-modal" style="display:none;">
            <div class="thb-modal-backdrop" data-close="1"></div>

            <div class="thb-modal-card" role="dialog" aria-modal="true" aria-labelledby="thbTarjetasTitle">
              <div class="thb-modal-head">
                <div>
                  <div id="thbTarjetasTitle" class="thb-modal-title">Tarjetas (THB)</div>
                  <div id="thbTarjetasSub" class="thb-modal-sub">‚Äî</div>
                </div>
                <button type="button" id="thbTarjetasClose" class="thb-modal-close" aria-label="Cerrar">√ó</button>
              </div>

              <div id="thbTarjetasBody" class="thb-modal-body">
                <div class="thb-modal-loading">Cargando‚Ä¶</div>
              </div>
            </div>
          </div>


          <div id="lenRangesInfo" class="subtitle"
               style="display:none; margin:6px 0 0 0; font-weight:900;">
            Longitudes (Industrial): <b>Peque√±o ‚â§ 300 mm</b> ¬∑ <b>Mediano 301‚Äì800 mm</b> ¬∑ <b>Largo &gt; 800 mm</b>
          </div>

          <div id="inlineDebug" style="display:none; margin-top:12px;">
            <h3 style="margin:0 0 8px 0;">Debug</h3>
            <pre id="inlineDebugPre" style="white-space:pre-wrap"></pre>
          </div>
        </div>
      </form>
    {% endif %}

  </div>
</div>
{% endif %}


<script>
document.addEventListener("DOMContentLoaded", () => {
  const el = document.getElementById("selectMachineTitle");
  if(!el) return;
  if(el.dataset.typerRunning === "1") return;
  el.dataset.typerRunning = "1";

  const full = (el.dataset.text || "").trim();
  if(!full) return;

  const typeSpeed = 70;
  const eraseSpeed = 35;
  const holdFull = 900;

  let i = 1;          // nunca queda vac√≠o
  let mode = "typing";

  el.textContent = full.slice(0, i);

  function step(){
    if(mode === "typing"){
      if(i < full.length){
        i++;
        el.textContent = full.slice(0, i);
        return setTimeout(step, typeSpeed);
      }
      return setTimeout(() => { mode = "erasing"; step(); }, holdFull);
    }

    // borrar SIN llegar a 0 (evita que desaparezca)
    if(i > 1){
      i--;
      el.textContent = full.slice(0, i);
      return setTimeout(step, eraseSpeed);
    }

    mode = "typing";
    setTimeout(step, typeSpeed);
  }

  setTimeout(step, typeSpeed);
});
</script>



<script>
  // Config para que el JS externo NO use Jinja dentro del .js
  window.LINE_START_CFG = {
    line_key: {{ line_key|tojson }},
    stage: {{ stage|tojson }},
    filename: {{ (filename or "")|tojson }},
    machine: {{ (machine or "")|tojson }},
    subcat: {{ (subcat or "")|tojson }},
    machine_id: {{ (machine_id or "")|tojson }},
    urls: {
      period_options: {{ url_for('period_options')|tojson }},
      thb_filter_options: {{ url_for('thb_filter_options')|tojson }},
      app_filter_options: {{ url_for('app_filter_options')|tojson }},
      run_analysis_api: {{ url_for('run_analysis_api')|tojson }},
      thb_tarjetas_hour: {{ url_for('thb_tarjetas_hour')|tojson }}
    }
  };
</script>

<script src="{{ url_for('static', filename='js/line_start.js') }}" defer></script>

{% endblock %}
